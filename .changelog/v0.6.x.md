# Release v0.6.x - FamilySearch Normalization & Architecture Refinement

Released: YYYY-MM-DD

## Overview

This release normalizes FamilySearch as a downstream provider (equal to Ancestry, WikiTree, etc.) and establishes SparseTree SQLite as the canonical source of truth. Major architectural cleanup removes all legacy fallback code in favor of migration scripts.

## New Features

### Ancestry Vital Info Upload (v0.6.x)
- Extended Ancestry upload to support birth date, birth place, death date, death place, and name (not just photos)
- Upload dialog now shows field-by-field comparison between local SparseTree data and cached Ancestry data
- Browser automation uses Ancestry's Quick Edit sidebar to update person facts
- Automatically handles Living/Deceased status toggle when setting death information
- Pre-selects all differing fields for upload convenience

### FamilySearch Normalization (v0.6.5)
- FamilySearch now treated as equal downstream provider (no special priority)
- Photos use `-familysearch` suffix like other providers: `{personId}-familysearch.jpg`
- Added `linkFamilySearch()` and `getFamilySearchPhotoPath()` to augmentation service
- ID resolution uses alphabetical order (no FamilySearch priority)

### Architecture: Source of Truth Principle (v0.6.x)
- SparseTree SQLite is now the canonical source of truth
- Provider cache (`data/provider-cache/`) is for comparison only, not a fallback data source
- All data reads come from SQLite; provider cache shows what providers have vs what SparseTree has

## Bug Fixes

### Fan Chart Ancestor Count (v0.6.x)
- Fixed footer showing incorrect count like "109 of 62 ancestors shown"
- Now correctly counts only ancestors within the visible generation range

### Stale Browser Connection Detection (v0.6.x)
- Added `verifyAndReconnect()` to browser service that checks both Playwright state and actual browser process
- Augmentation service now detects and recovers from stale connections before scraping
- Fixes silent failures when browser was closed but connection state was still "connected"

### "Set as Primary" Photo Not Updating (v0.6.x)
- Fixed photo not updating after clicking "Set as Primary" on provider photos
- Root causes fixed:
  - `getPhotoPath()` now checks for primary photo (`{personId}.jpg`) before provider-suffixed photos
  - Photo priority in PersonDetail header and SparseTree row now shows primary photo first
  - Added `Cache-Control: no-cache` headers to all photo "exists" endpoints to prevent stale responses
- Added FamilySearch-specific photo endpoint: `GET /augment/:personId/familysearch-photo`
- Added client API methods: `getFsPhotoUrl()`, `hasFsPhotoProvider()`
- Added `photoVersion` state for cache-busting photo URLs after changes

### HMR Context Resilience (v0.6.x)
- Fixed "useSidebar must be used within a SidebarProvider" error during HMR transitions
- `useSidebar()` and `useTheme()` hooks now return safe defaults during dev hot reloads
- Prevents crashes when React context identity changes during development

## Improvements

### Tree Visualization Parity with Ancestry.com (v0.6.x)
- Added 5 tree view modes matching Ancestry.com functionality
- **Fan Chart** (default): Radial pedigree with lineage-colored wedges (paternal=blue/teal, maternal=red/coral)
- **Horizontal Pedigree**: Root left, ancestors right with expandable nodes
- **Vertical Family**: Ancestors top, root middle with generation labels
- **Columns** and **Focus**: Existing views retained
- URL-based routing: `/tree/:dbId/:personId/:viewMode`
- New shared components: TreeCanvas (D3 zoom/pan), TreeControls, AncestorNode
- New utilities: lineageColors, treeLayout, arcGenerator
- Fixed classic view bugs: dynamic centering, ResizeObserver instead of setTimeout

### Avatar Placeholders (v0.6.x)
- Replaced emoji-based avatar placeholders with proper SVG components throughout tree views
- New `AvatarPlaceholder` component renders gender-aware silhouettes (male/female/unknown profiles)
- Updated PersonCard, FocusNavigatorView, GenerationalColumnsView, PedigreeChartView, and SparseTreePage
- Softened gender color palette for better visual harmony (less saturated blue/pink)

### Legacy Code Removal (v0.6.x)
- Removed all legacy fallback code from services (no more dual-path lookups)
- Services updated: `familysearch-refresh`, `multi-platform-comparison`, `augmentation`, `scraper`, `person.routes`
- Architecture policy: use migration scripts instead of maintaining legacy paths

## Migration Scripts

### Photo Migration
- `scripts/migrate-fs-photos.ts` - Renames FamilySearch photos from `{personId}.jpg` to `{personId}-familysearch.jpg`

### Cache Migration
- `scripts/migrate-legacy-cache.ts` - Moves JSON files from `data/person/` to `data/provider-cache/familysearch/`

## Technical Details

### Source of Truth Architecture
```
┌─────────────────────────────────────────────────────────────────┐
│                     Layer 3: Local Overrides                    │
│  User edits that take precedence and survive provider re-sync   │
├─────────────────────────────────────────────────────────────────┤
│                    Layer 2: Normalized Data (SQLite)            │
│  CANONICAL SOURCE OF TRUTH - all reads come from here           │
├─────────────────────────────────────────────────────────────────┤
│                     Layer 1: Raw Provider Cache                 │
│  For comparison only - shows what providers have                │
└─────────────────────────────────────────────────────────────────┘
```

### Key Principles
1. **Initial Seeding**: When indexing, data writes to both SQLite (as record) AND provider-cache (for comparison)
2. **No Fallback Code**: Migration scripts upgrade data in place; no dual-path lookups
3. **Explicit Apply**: Downloaded provider data is cached but never auto-applied; users click "Use" buttons
4. **Provider Equality**: All providers treated equally as downstream data sources

## Full Changelog

**Full Diff**: https://github.com/atomantic/SparseTree/compare/v0.5.4...v0.6.x
