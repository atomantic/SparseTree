# Release v0.6.x - FamilySearch Normalization & Architecture Refinement

Released: YYYY-MM-DD

## Overview

This release normalizes FamilySearch as a downstream provider (equal to Ancestry, WikiTree, etc.) and establishes SparseTree SQLite as the canonical source of truth. Major architectural cleanup removes all legacy fallback code in favor of migration scripts.

## New Features

### FamilySearch Normalization (v0.6.5)
- FamilySearch now treated as equal downstream provider (no special priority)
- Photos use `-familysearch` suffix like other providers: `{personId}-familysearch.jpg`
- Added `linkFamilySearch()` and `getFamilySearchPhotoPath()` to augmentation service
- ID resolution uses alphabetical order (no FamilySearch priority)

### Architecture: Source of Truth Principle (v0.6.x)
- SparseTree SQLite is now the canonical source of truth
- Provider cache (`data/provider-cache/`) is for comparison only, not a fallback data source
- All data reads come from SQLite; provider cache shows what providers have vs what SparseTree has

## Bug Fixes

### "Set as Primary" Photo Not Updating (v0.6.x)
- Fixed photo not updating after clicking "Set as Primary" on provider photos
- Root causes fixed:
  - `getPhotoPath()` now checks for primary photo (`{personId}.jpg`) before provider-suffixed photos
  - Photo priority in PersonDetail header and SparseTree row now shows primary photo first
  - Added `Cache-Control: no-cache` headers to all photo "exists" endpoints to prevent stale responses
- Added FamilySearch-specific photo endpoint: `GET /augment/:personId/familysearch-photo`
- Added client API methods: `getFsPhotoUrl()`, `hasFsPhotoProvider()`
- Added `photoVersion` state for cache-busting photo URLs after changes

### HMR Context Resilience (v0.6.x)
- Fixed "useSidebar must be used within a SidebarProvider" error during HMR transitions
- `useSidebar()` and `useTheme()` hooks now return safe defaults during dev hot reloads
- Prevents crashes when React context identity changes during development

## Improvements

### Legacy Code Removal (v0.6.x)
- Removed all legacy fallback code from services (no more dual-path lookups)
- Services updated: `familysearch-refresh`, `multi-platform-comparison`, `augmentation`, `scraper`, `person.routes`
- Architecture policy: use migration scripts instead of maintaining legacy paths

## Migration Scripts

### Photo Migration
- `scripts/migrate-fs-photos.ts` - Renames FamilySearch photos from `{personId}.jpg` to `{personId}-familysearch.jpg`

### Cache Migration
- `scripts/migrate-legacy-cache.ts` - Moves JSON files from `data/person/` to `data/provider-cache/familysearch/`

## Technical Details

### Source of Truth Architecture
```
┌─────────────────────────────────────────────────────────────────┐
│                     Layer 3: Local Overrides                    │
│  User edits that take precedence and survive provider re-sync   │
├─────────────────────────────────────────────────────────────────┤
│                    Layer 2: Normalized Data (SQLite)            │
│  CANONICAL SOURCE OF TRUTH - all reads come from here           │
├─────────────────────────────────────────────────────────────────┤
│                     Layer 1: Raw Provider Cache                 │
│  For comparison only - shows what providers have                │
└─────────────────────────────────────────────────────────────────┘
```

### Key Principles
1. **Initial Seeding**: When indexing, data writes to both SQLite (as record) AND provider-cache (for comparison)
2. **No Fallback Code**: Migration scripts upgrade data in place; no dual-path lookups
3. **Explicit Apply**: Downloaded provider data is cached but never auto-applied; users click "Use" buttons
4. **Provider Equality**: All providers treated equally as downstream data sources

## Full Changelog

**Full Diff**: https://github.com/atomantic/SparseTree/compare/v0.5.4...v0.6.x
