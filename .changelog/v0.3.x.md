# Release v0.3.x - SQLite Storage Layer & Migration Framework

Released: YYYY-MM-DD

## Overview

Major architectural upgrade introducing SQLite as a high-performance index layer while maintaining JSON files as the source of truth. This release adds canonical ULID-based identities, full-text search via FTS5, recursive CTEs for path finding, and a comprehensive data migration framework.

## ðŸŽ‰ New Features

### SQLite Storage Layer
- Added SQLite database (`data/sparsetree.db`) as fast query index
- FTS5 full-text search for person names, bios, and occupations
- Recursive CTEs for efficient ancestor/descendant path finding
- WAL mode for better read concurrency
- Auto-enables when database exists with data, falls back to JSON otherwise

### Canonical Identity System
- ULID-based canonical IDs (26-char, sortable, collision-resistant)
- External identity mappings for multiple providers (FamilySearch, Ancestry, WikiTree, 23andMe)
- Bidirectional ID lookup with in-memory LRU cache
- Confidence scoring for identity assertions

### Content-Addressed Blob Storage
- SHA-256 hash-based media storage (`data/blobs/{hash[:2]}/{hash}.{ext}`)
- Automatic deduplication of duplicate photos
- Media records linked to persons with primary photo support

### Data Migration Framework
- Automatic schema and data migrations on update
- Migration tracking in `data/.data-version` and SQLite `migration` table
- Dry-run mode for previewing changes
- Rollback support for reversible migrations
- Commands: `npm run migrate`, `npm run migrate:status`, `npm run migrate:dry-run`

### Update Script
- New `./update.sh` for one-command updates
- Pulls latest code, installs deps, builds, migrates, restarts
- Supports `--dry-run`, `--no-restart`, `--branch=NAME` options
- Safe: checks for uncommitted changes before updating

## ðŸ”§ Improvements

### Service Layer Updates
- `database.service.ts` - Queries from SQLite with JSON fallback
- `search.service.ts` - Uses FTS5 for text search, supports cross-database global search
- `path.service.ts` - Recursive CTEs for shortest/longest/random paths
- `favorites.service.ts` - SQLite storage with JSON backup
- `augmentation.service.ts` - External identity registration

### Schema Design
- Normalized tables: `person`, `external_identity`, `parent_edge`, `spouse_edge`
- Extensible claims system for facts with provenance
- Vital events with date parsing (supports BC notation)
- Database membership for multi-tree support
- Full schema in `server/src/db/schema.sql`

### Developer Experience
- Updated CLAUDE.md with comprehensive migration documentation
- Added npm scripts for migration management
- Better error messages for ID resolution failures

## ðŸ“¦ Installation

```bash
git clone https://github.com/atomantic/SparseTree.git
cd SparseTree
npm run install:all
npm run migrate
pm2 start ecosystem.config.cjs
```

## ðŸ”„ Upgrading from v0.2.x

Run the update script to automatically migrate:

```bash
./update.sh
```

Or manually:

```bash
git pull origin main
npm install
npm run build
npm run migrate
pm2 restart ecosystem.config.cjs
```

## ðŸ”— Full Changelog

**Full Diff**: https://github.com/atomantic/SparseTree/compare/v0.2.11...v0.3.x
